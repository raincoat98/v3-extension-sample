rules_version='2'

service cloud.firestore {
  match /databases/{database}/documents {
    // items 컬렉션: userId 필드를 기반으로 접근 제어
    match /items/{itemId} {
      // 읽기 (단일 문서 및 쿼리 모두):
      // userId 필드가 쿼리 조건과 일치하는 경우 허용
      // (보안: 클라이언트는 userId를 알아야 접근 가능)
      allow read: if resource.data.userId != null;

      // 쓰기(생성): 로그인했고, 생성하려는 데이터의 userId가 현재 사용자의 uid와 일치하는 경우
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid;

      // 업데이트: 로그인했고, 기존 데이터의 userId가 현재 사용자의 uid와 일치하고, 업데이트 후에도 userId가 변경되지 않는 경우
      allow update: if request.auth != null
                    && resource.data.userId == request.auth.uid
                    && request.resource.data.userId == request.auth.uid;

      // 삭제: 로그인했고, 삭제하려는 데이터의 userId가 현재 사용자의 uid와 일치하는 경우
      allow delete: if request.auth != null
                    && resource.data.userId == request.auth.uid;
    }
  }
}
